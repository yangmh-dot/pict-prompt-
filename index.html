<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 短片提示詞生成器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: none;
            margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 font-sans">

    <div class="max-w-md mx-auto bg-gray-800 rounded-xl shadow-lg overflow-hidden p-6">
        <h1 class="text-2xl font-bold text-center mb-2 text-blue-400">AI 提示詞生成器 (v2)</h1>
        <p class="text-xs text-center text-gray-400 mb-6">丟入圖片或 YT 連結，產生中英文 Prompt</p>

        <div class="mb-4">
            <label class="block text-sm font-medium mb-1 text-gray-300">Google Gemini API Key</label>
            <input type="password" id="apiKey" placeholder="貼上你的 API Key" 
                class="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:border-blue-500 focus:outline-none text-white text-sm">
            <p class="text-xs text-gray-500 mt-1">金鑰僅儲存在您的瀏覽器中。</p>
        </div>

        <div class="flex border-b border-gray-600 mb-4">
            <button onclick="switchTab('image')" id="btn-image" class="flex-1 py-2 text-blue-400 border-b-2 border-blue-400 font-medium">上傳圖片</button>
            <button onclick="switchTab('youtube')" id="btn-youtube" class="flex-1 py-2 text-gray-400 font-medium">YouTube 連結</button>
        </div>

        <div id="tab-image" class="block">
            <div class="border-2 border-dashed border-gray-600 rounded-lg p-4 text-center cursor-pointer hover:bg-gray-700 transition" onclick="document.getElementById('fileInput').click()">
                <p class="text-gray-400">點擊上傳或貼上截圖</p>
                <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleFileSelect(event)">
            </div>
            <img id="previewImage" class="w-full mt-4 rounded hidden object-cover max-h-60" />
        </div>

        <div id="tab-youtube" class="hidden">
            <input type="text" id="ytUrl" placeholder="貼上 YouTube Shorts 連結" 
                class="w-full p-2 rounded bg-gray-700 border border-gray-600 mb-2 text-white"
                onchange="handleYoutubeLink()">
            <div id="ytPreviewArea" class="hidden mt-2">
                <p class="text-xs text-gray-400 mb-1">已擷取封面圖：</p>
                <img id="ytThumbnail" class="w-full rounded object-cover max-h-60">
                <p class="text-xs text-yellow-500 mt-1">*注意：將根據封面圖進行分析</p>
            </div>
        </div>

        <button onclick="generatePrompt()" 
            class="w-full mt-6 bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded transition duration-200">
            開始分析生成
        </button>

        <div id="loader" class="loader mt-4"></div>

        <div id="resultArea" class="hidden mt-6 bg-gray-700 p-4 rounded border border-gray-600">
            <h3 class="text-sm font-bold text-green-400 mb-2">英文提示詞 (Midjourney/SD):</h3>
            <div class="relative">
                <p id="outputEn" class="text-sm text-gray-200 bg-gray-800 p-2 rounded break-words"></p>
                <button onclick="copyToClipboard('outputEn')" class="absolute top-1 right-1 text-xs bg-gray-600 px-2 py-1 rounded hover:bg-gray-500">複製</button>
            </div>
            
            <h3 class="text-sm font-bold text-green-400 mt-4 mb-2">中文描述:</h3>
            <p id="outputZh" class="text-sm text-gray-200 bg-gray-800 p-2 rounded break-words"></p>
        </div>
    </div>

    <script>
        let currentImageBase64 = null;
        let currentMimeType = null;

        // 讀取舊的 API Key
        document.getElementById('apiKey').value = localStorage.getItem('gemini_api_key') || '';

        function switchTab(tab) {
            if(tab === 'image') {
                document.getElementById('tab-image').classList.remove('hidden');
                document.getElementById('tab-youtube').classList.add('hidden');
                document.getElementById('btn-image').className = "flex-1 py-2 text-blue-400 border-b-2 border-blue-400 font-medium";
                document.getElementById('btn-youtube').className = "flex-1 py-2 text-gray-400 font-medium";
            } else {
                document.getElementById('tab-image').classList.add('hidden');
                document.getElementById('tab-youtube').classList.remove('hidden');
                document.getElementById('btn-image').className = "flex-1 py-2 text-gray-400 font-medium";
                document.getElementById('btn-youtube').className = "flex-1 py-2 text-blue-400 border-b-2 border-blue-400 font-medium";
            }
            currentImageBase64 = null;
            document.getElementById('resultArea').classList.add('hidden');
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            processFile(file);
        }

        window.addEventListener('paste', e => {
            if (e.clipboardData.files.length > 0) {
                processFile(e.clipboardData.files[0]);
                switchTab('image');
            }
        });

        function processFile(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onloadend = function() {
                currentImageBase64 = reader.result.split(',')[1];
                currentMimeType = file.type;
                const img = document.getElementById('previewImage');
                img.src = reader.result;
                img.classList.remove('hidden');
            }
            reader.readAsDataURL(file);
        }

        async function handleYoutubeLink() {
            const url = document.getElementById('ytUrl').value;
            const vidMatch = url.match(/(?:youtu\.be\/|youtube\.com(?:\/embed\/|\/v\/|\/watch\?v=|\/user\/\S+|\/ytscreeningroom\?v=|\/sandalsResorts#\w\/\w\/.*\/))([^\/&]{10,12})/);
            const shortsMatch = url.match(/shorts\/([^\/&?]{10,12})/);
            
            let videoId = null;
            if (shortsMatch) videoId = shortsMatch[1];
            else if (vidMatch) videoId = vidMatch[1];

            if (videoId) {
                const thumbUrl = `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;
                const img = document.getElementById('ytThumbnail');
                img.src = thumbUrl;
                document.getElementById('ytPreviewArea').classList.remove('hidden');

                try {
                    const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(thumbUrl)}`);
                    const blob = await response.blob();
                    const reader = new FileReader();
                    reader.onloadend = function() {
                        currentImageBase64 = reader.result.split(',')[1];
                        currentMimeType = "image/jpeg";
                    }
                    reader.readAsDataURL(blob);
                } catch (e) {
                    alert("注意：無法自動讀取此 YouTube 封面（CORS 限制）。\n請改用手機截圖，並使用「上傳圖片」功能，效果最穩！");
                }
            }
        }

        async function generatePrompt() {
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) return alert("請輸入 API Key");
            if (!currentImageBase64) return alert("請先上傳圖片或有效的 YouTube 連結");

            localStorage.setItem('gemini_api_key', apiKey);

            document.getElementById('loader').style.display = 'block';
            document.getElementById('resultArea').classList.add('hidden');

            // ★★★ 修改重點：將模型名稱改為 gemini-1.5-flash-latest ★★★
            const MODEL_NAME = "gemini-1.5-flash-latest"; 
            
            const promptText = `
                Please analyze this image.
                1. Identify the style, lighting, camera angle, main subject, and color palette.
                2. Generate a high-quality AI image generation prompt (in English) suitable for Stable Diffusion or Midjourney. Keep it descriptive and comma-separated.
                3. Write a short content description in Traditional Chinese (繁體中文).
                
                Return the result in this JSON format without markdown code blocks:
                {
                    "prompt_en": "...",
                    "desc_zh": "..."
                }
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: promptText },
                                { inline_data: { mime_type: currentMimeType, data: currentImageBase64 } }
                            ]
                        }]
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }

                const rawText = data.candidates[0].content.parts[0].text;
                const cleanJson = rawText.replace(/```json|```/g, '').trim();
                
                try {
                    const result = JSON.parse(cleanJson);
                    document.getElementById('outputEn').innerText = result.prompt_en;
                    document.getElementById('outputZh').innerText = result.desc_zh;
                    document.getElementById('resultArea').classList.remove('hidden');
                } catch (e) {
                    // 如果 AI 沒有回傳標準 JSON，直接顯示原始文字
                    document.getElementById('outputZh').innerText = rawText;
                    document.getElementById('outputEn').innerText = "（解析 JSON 失敗，請參考上方內容）";
                    document.getElementById('resultArea').classList.remove('hidden');
                }

            } catch (error) {
                alert("發生錯誤: " + error.message);
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        function copyToClipboard(id) {
            const text = document.getElementById(id).innerText;
            navigator.clipboard.writeText(text).then(() => {
                alert("已複製！");
            });
        }
    </script>
</body>
</html>
